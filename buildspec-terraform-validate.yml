version: 0.2

# Terraform Static Analysis Buildspec
# =====================================
# This buildspec runs static analysis on Terraform code for PR validation
# - terraform validate: Syntax and internal consistency checks
# - checkov: Security and compliance scanning
# - tflint: Linting and best practices validation
#
# Triggered on: Pull Request creation/update to develop, release, or main branches
# Reports results back to GitHub PR with approval/rejection

env:
  variables:
    TERRAFORM_DIR: "terraform"
    CHECKOV_CONFIG: "terraform/.checkov.yml"
    TFLINT_CONFIG: "terraform/.tflint.hcl"

phases:
  install:
    runtime-versions:
      python: 3.11
    commands:
      - echo "Installing Terraform..."
      - cd /tmp
      - rm -f terraform terraform_*.zip
      - wget -q https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_linux_amd64.zip
      - unzip -q terraform_1.5.7_linux_amd64.zip
      - chmod +x terraform
      - mv terraform /usr/local/bin/
      - rm -f terraform_*.zip
      - cd $CODEBUILD_SRC_DIR
      - terraform version
      
      - echo "Installing Checkov..."
      - pip install checkov --quiet
      - checkov --version
      
      - echo "Installing TFLint..."
      - curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
      - tflint --version

  pre_build:
    commands:
      - echo "Initializing Terraform static analysis..."
      - echo "Repository ${GITHUB_REPO}"
      - echo "Target branch ${TARGET_BRANCH}"
      - echo "Commit SHA ${CODEBUILD_RESOLVED_SOURCE_VERSION}"
      - export VALIDATION_FAILED=0

  build:
    commands:
      - echo "==================================="
      - echo "1. Running Terraform Validate"
      - echo "==================================="
      - cd $CODEBUILD_SRC_DIR/$TERRAFORM_DIR
      - export VALIDATION_FAILED=0
      - export VALIDATION_OUTPUT=""
      
      # Terraform Validate for all modules
      - |
        for dir in modules/*/; do
          echo "Validating $(basename $dir)..."
          cd $CODEBUILD_SRC_DIR/$TERRAFORM_DIR/$dir
          terraform init -backend=false > /dev/null 2>&1
          if terraform validate > /tmp/tf-validate-$(basename $dir).txt 2>&1; then
            echo "✅ $(basename $dir) - PASSED"
          else
            echo "❌ $(basename $dir) - FAILED"
            export VALIDATION_FAILED=1
            export VALIDATION_OUTPUT="${VALIDATION_OUTPUT}\n\n**$(basename $dir):**\n\`\`\`\n$(cat /tmp/tf-validate-$(basename $dir).txt)\n\`\`\`"
          fi
        done
      
      - echo ""
      - echo "==================================="
      - echo "2. Running Checkov Security Scan"
      - echo "==================================="
      - cd $CODEBUILD_SRC_DIR/$TERRAFORM_DIR
      - |
        if checkov -d . --config-file $CODEBUILD_SRC_DIR/$CHECKOV_CONFIG --compact --quiet > /tmp/checkov-output.txt 2>&1; then
          echo "✅ Checkov - PASSED"
          CHECKOV_RESULT="✅ **Checkov Security Scan:** PASSED"
        else
          CHECKOV_EXIT_CODE=$?
          if [ $CHECKOV_EXIT_CODE -eq 1 ]; then
            echo "❌ Checkov - FAILED (Security issues found)"
            export VALIDATION_FAILED=1
            # Extract summary from checkov output
            CHECKOV_SUMMARY=$(grep -A 20 "Passed checks:" /tmp/checkov-output.txt || echo "See full output above")
            CHECKOV_RESULT="❌ **Checkov Security Scan:** FAILED\n\`\`\`\n${CHECKOV_SUMMARY}\n\`\`\`"
          else
            echo "⚠️  Checkov - WARNING (Non-security error: exit code $CHECKOV_EXIT_CODE)"
            CHECKOV_RESULT="⚠️  **Checkov Security Scan:** WARNING (exit code $CHECKOV_EXIT_CODE)"
          fi
        fi
      
      - echo ""
      - echo "==================================="
      - echo "3. Running TFLint"
      - echo "==================================="
      - cd $CODEBUILD_SRC_DIR/$TERRAFORM_DIR
      - |
        tflint --init > /dev/null 2>&1
        if tflint --config $CODEBUILD_SRC_DIR/$TFLINT_CONFIG --recursive --format compact > /tmp/tflint-output.txt 2>&1; then
          echo "✅ TFLint - PASSED"
          TFLINT_RESULT="✅ **TFLint:** PASSED"
        else
          echo "❌ TFLint - FAILED"
          export VALIDATION_FAILED=1
          TFLINT_SUMMARY=$(head -20 /tmp/tflint-output.txt)
          TFLINT_RESULT="❌ **TFLint:** FAILED\n\`\`\`\n${TFLINT_SUMMARY}\n\`\`\`"
        fi

  post_build:
    commands:
      - echo "==================================="
      - echo "Final Results"
      - echo "==================================="
      - |
        # Report results - GitHub will show status check automatically
        if [ $VALIDATION_FAILED -eq 0 ]; then
          echo "✅ ALL CHECKS PASSED"
          echo "- Terraform Validate: PASSED"
          echo "- Checkov: PASSED"
          echo "- TFLint: PASSED"
          exit 0
        else
          echo "❌ VALIDATION FAILED"
          echo "Review the logs above for details"
          exit 1
        fi

artifacts:
  files:
    - /tmp/*-output.txt
  name: terraform-validation-results
